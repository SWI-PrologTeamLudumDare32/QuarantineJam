<!DOCTYPE html>
<script src="/static/vendor/mithril-2.0.4.js"></script>

<div id="app"></div>

<script>
  let state = null
  let oops = ''

const App = {
  view() {
    if (!state) {
      return m('div', 'Loading...')
    }
    return m('div',
      m('h2', 'The Text Farmer'),

      state.actions.map(action =>
        m('button', {
          onclick() { act(action) }
        }, action),
      ),

      m('pre', JSON.stringify(state.items, undefined, 2)),
      m('pre', JSON.stringify(state.env, undefined, 2)),
      oops && m('pre', oops)
    )
  }
}

async function act(action) {
  const response = await m.request({
    method: 'POST',
    url: '/game_turn',
    body: { action },
  })

  state = {
    items: response.result,
    env: response.env.reduce((hash, [key, value]) => {
      hash[key] = value
      return hash
    }, {}),
    actions: response.available_actions,
  }
  oops = response.error
}

act('get_state')

m.mount(document.getElementById('app'), App)
</script>
