<!DOCTYPE html>
<script src="/static/vendor/mithril-2.0.4.js"></script>

<div id="app"></div>

<script>
  let state = null
  let oops = ''

const App = {
  view() {
    return m('div',
      m('h2', 'The XMLHttpRequest Object'),

      m('button', {
        onclick() { gameTurn({ add: ['cow'] , remove: ['money'] }) }
      }, 'buy cow'),

      m('button', {
        onclick() { gameTurn({ end_turn: true }) }
      }, 'end turn'),

      state && [
        m('pre', JSON.stringify(state.items, undefined, 2)),
        m('pre', JSON.stringify(state.env, undefined, 2))
      ],
      oops && m('pre', oops)
    )
  }
}

async function gameTurn(body) {
  const response = await m.request({
    method: 'POST',
    url: '/game_turn',
    body: {
      add: body.add || [],
      remove: body.remove || [],
      end_turn: body.end_turn ? 1 : 0,
    },
  })

  state = {
    items: response.result,
    env: response.env.reduce((hash, [key, value]) => {
      hash[key] = value
      return hash
    }, {})
  }
  oops = response.error
}

m.mount(document.getElementById('app'), App)
</script>
